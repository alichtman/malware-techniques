/**
 * This technique is drawn from a Symantec paper titled: "Attacks on Virtual
 * Machine Emulators" and can be found at:
 * https://www.symantec.com/content/dam/symantec/docs/security-center/white-papers/attacks-on-virtual-machine-emulators-07-en.pdf
 *
 * @return True if VMware is detected, false otherwise.
 */

// TODO: FIX COMPILATION ERRORS!!
bool detect_vmware_with_assembly_trick() {

	asm volatile goto ("mov $564d5868h, %%eax"
	                   "mov 0ah, %%ecx"
	                   "mov $5658h, %%dx"
	                   "in  %%dx, %%eax"
	                   "cmp $564d5868h, %%ebx"
	                   "je %l0" // Jump to detected label
	                   : // No outputs
	                   : // No inputs
	                   :"eax", "ebx", "ecx", "dx" // clobbered registers
	                   : detected);

	// If we don't jump to detected, fall through to here.
	return false;

detected:
	return true;

}

int main() {
	if (detect_vmware_with_assembly_trick()) {
		printf("Detected VMware!\n");
	} else {
		printf("Did not detect VMware!\n");
	}

	return 0;
}
