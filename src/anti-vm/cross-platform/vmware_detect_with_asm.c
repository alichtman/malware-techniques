/**
 * This technique is drawn from a Symantec paper titled: "Attacks on Virtual
 * Machine Emulators" and can be found at:
 * https://www.symantec.com/content/dam/symantec/docs/security-center/white-papers/attacks-on-virtual-machine-emulators-07-en.pdf
 *
 * @return True if VMware is detected, false otherwise.
 */

#include <stdio.h>

// TODO: FIX SEGFAULT
int detect_vmware_with_assembly_trick() {

	asm ("movl $564d5868h, %%eax\n"
	     "movl 0ah, %%ecx\n"
	     "movw $5658h, %%dx\n"
	     "in  %%dx, %%eax\n"
	     "cmp $564d5868h, %%ebx\n"
	     "pushf\n"      // Put FLAGS register on stack
	     "pop %%ax\n"   // Put FLAGS register into ax
	     "push %%ax\n"  // Copy back onto stack for storage
	     "andl $40h, %%eax\n"  // Isolate zero flag from FLAGS register in eax
	     "shr $6, %%eax\n" // Set eax equal to either 0 or 1. 1 means it was detected.
	     "popf\n" // Restore FLAGS
	     : // No outputs
	     : // No inputs
	     :"eax", "ebx", "ax", "dx"); // clobbered registers

	// eax should be implicitly returned.
}

int main() {
	if (detect_vmware_with_assembly_trick() == 1) {
		printf("Detected VMware!\n");
	} else {
		printf("Did not detect VMware!\n");
	}

	return 0;
}
